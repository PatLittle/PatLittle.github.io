---
layout: default
---

<div class="container post-layout">
  <div class="post-main">
    <h1>{{ page.title }}</h1>
    <div class="post-meta">{{ page.date | date: '%B %d, %Y' }} Â· {{ page.category | default: 'Writing' }}</div>
  </div>

  <div class="post-shell">
    <aside class="post-sidenav" aria-label="On this page">
      <div class="sidenav-title">On this page</div>
      <nav id="post-toc"></nav>
    </aside>

    <main class="post-main">
      <div class="post-content" id="post-content">
        {{ content }}
      </div>
    </main>
  </div>
</div>

<!-- Gallery modal -->
<div class="gallery-modal" id="galleryModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="gallery-dialog" role="document">
    <div class="gallery-bar">
      <div class="gallery-title" id="galleryTitle">Gallery</div>
      <div class="gallery-actions">
        <button class="gallery-btn" type="button" id="galleryPrev" aria-label="Previous image">Prev</button>
        <button class="gallery-btn" type="button" id="galleryNext" aria-label="Next image">Next</button>
        <button class="gallery-btn" type="button" id="galleryClose" aria-label="Close gallery">Close</button>
      </div>
    </div>

    <div class="gallery-stage" id="galleryStage">
      <!-- click zones for prev/next -->
      <div class="gallery-navzone prev" id="galleryZonePrev" aria-hidden="true"></div>
      <div class="gallery-navzone next" id="galleryZoneNext" aria-hidden="true"></div>

      <img id="galleryImage" alt="" />
    </div>

    <div class="gallery-caption" id="galleryCaption"></div>
  </div>
</div>

<script>
  (function () {
    const root = document.querySelector(".post-content");
    const toc = document.getElementById("post-toc");
    if (!root || !toc) return;

    // ---------- Heading anchors + TOC ----------
    const slugify = (text) =>
      text
        .toLowerCase()
        .trim()
        .replace(/[\s]+/g, "-")
        .replace(/[^\w\-]+/g, "")
        .replace(/\-+/g, "-");

    const used = new Map();
    const uniqueId = (base) => {
      const n = used.get(base) || 0;
      used.set(base, n + 1);
      return n ? `${base}-${n + 1}` : base;
    };

    const headings = Array.from(root.querySelectorAll("h2, h3, h4"));

    headings.forEach((h) => {
      // Ensure an id
      let id = h.id && h.id.trim() ? h.id.trim() : slugify(h.textContent);
      if (!id) return;
      id = uniqueId(id);
      h.id = id;

      // Wrap heading content in an anchor if not already wrapped
      if (!h.querySelector("a.heading-anchor")) {
        // If heading already has any link, leave it (avoid nested anchors)
        if (!h.querySelector("a")) {
          const a = document.createElement("a");
          a.className = "heading-anchor";
          a.href = `#${id}`;
          while (h.firstChild) a.appendChild(h.firstChild);
          h.appendChild(a);
        }
      }

      // Add to TOC
      const link = document.createElement("a");
      link.href = `#${id}`;
      link.textContent = h.textContent.trim();
      link.classList.add(`level-${h.tagName.toLowerCase()}`);
      toc.appendChild(link);
    });

    // Active link highlighting
    const tocLinks = Array.from(toc.querySelectorAll("a"));
    const byId = new Map(tocLinks.map((a) => [a.getAttribute("href").slice(1), a]));

    const setActive = (id) => {
      tocLinks.forEach((a) => a.classList.toggle("is-active", a.getAttribute("href") === `#${id}`));
    };

    const io = new IntersectionObserver(
      (entries) => {
        // Choose the closest visible heading to the top
        const visible = entries
          .filter((e) => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];
        if (visible && visible.target && visible.target.id && byId.has(visible.target.id)) {
          setActive(visible.target.id);
        }
      },
      { rootMargin: "-25% 0px -65% 0px", threshold: [0, 1] }
    );

    headings.forEach((h) => io.observe(h));

    // ---------- Image gallery modal ----------
const modal = document.getElementById("galleryModal");
const dialog = modal ? modal.querySelector(".gallery-dialog") : null;
const imgEl = document.getElementById("galleryImage");
const capEl = document.getElementById("galleryCaption");
const titleEl = document.getElementById("galleryTitle");
const btnPrev = document.getElementById("galleryPrev");
const btnNext = document.getElementById("galleryNext");
const btnClose = document.getElementById("galleryClose");
const zonePrev = document.getElementById("galleryZonePrev");
const zoneNext = document.getElementById("galleryZoneNext");

const galleryItems = Array.from(root.querySelectorAll("figure img")).map((img) => {
  const fig = img.closest("figure");
  const cap = fig ? fig.querySelector("figcaption") : null;
  return {
    el: img,
    src: img.currentSrc || img.src,
    alt: img.alt || "",
    caption: cap ? cap.textContent.trim() : ""
  };
});

let current = 0;
let lastFocused = null;

function renderGallery() {
  const item = galleryItems[current];
  imgEl.src = item.src;
  imgEl.alt = item.alt || "";
  capEl.textContent = item.caption || "";
  titleEl.textContent = `Image ${current + 1} of ${galleryItems.length}`;
}

function openAt(i) {
  if (!galleryItems.length) return;
  current = ((i % galleryItems.length) + galleryItems.length) % galleryItems.length;
  lastFocused = document.activeElement;

  renderGallery();
  modal.classList.add("is-open");
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
  btnClose && btnClose.focus();
}

function closeGallery() {
  modal.classList.remove("is-open");
  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  if (lastFocused && lastFocused.focus) lastFocused.focus();
}

function prevImage() {
  if (!galleryItems.length) return;
  openAt(current - 1);
}

function nextImage() {
  if (!galleryItems.length) return;
  openAt(current + 1);
}

// Click any gallery image to open
galleryItems.forEach((item, idx) => {
  item.el.dataset.galleryIndex = String(idx);
  item.el.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    openAt(idx);
  });
});

// Button wiring (stopPropagation prevents navzones/backdrop from hijacking clicks)
if (btnPrev) btnPrev.addEventListener("click", (e) => { e.stopPropagation(); prevImage(); });
if (btnNext) btnNext.addEventListener("click", (e) => { e.stopPropagation(); nextImage(); });
if (btnClose) btnClose.addEventListener("click", (e) => { e.stopPropagation(); closeGallery(); });

// Side click zones
if (zonePrev) zonePrev.addEventListener("click", (e) => { e.stopPropagation(); prevImage(); });
if (zoneNext) zoneNext.addEventListener("click", (e) => { e.stopPropagation(); nextImage(); });

// Backdrop click closes (but clicks inside dialog do not)
if (modal) {
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeGallery();
  });
}
if (dialog) {
  dialog.addEventListener("click", (e) => e.stopPropagation());
}

// Keyboard
document.addEventListener("keydown", (e) => {
  if (!modal || !modal.classList.contains("is-open")) return;
  if (e.key === "Escape") closeGallery();
  if (e.key === "ArrowLeft") prevImage();
  if (e.key === "ArrowRight") nextImage();
});

  })();
</script>
